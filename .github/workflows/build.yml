name: build

on:
  push:
  pull_request:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        configuration: [Debug, Release]

    runs-on: windows-2022

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Add MSBuild to PATH
        uses: microsoft/setup-msbuild@v2

      - name: Install MFC libraries via Chocolatey
        run: |
          Write-Host "Installing MFC components via Chocolatey..."
          choco install visualstudio2022-workload-vctools --package-parameters "--add Microsoft.VisualStudio.Component.VC.ATLMFC" --yes

          # Wait for installation to complete
          Start-Sleep -Seconds 30

          # Verify installation
          $mfcPath = Get-ChildItem "${env:ProgramFiles}\Microsoft Visual Studio\2022\Enterprise\VC\Tools\MSVC\*\atlmfc" -ErrorAction SilentlyContinue
          if ($mfcPath) {
            Write-Host "✅ MFC libraries found at: $($mfcPath.FullName)"
          } else {
            Write-Host "❌ MFC installation failed"
            Get-ChildItem "${env:ProgramFiles}\Microsoft Visual Studio\2022\Enterprise\VC\Tools\MSVC\" -ErrorAction SilentlyContinue
            exit 1
          }
        shell: powershell

      - name: Run MSBuild with Code Analysis
        run: |
          $msbuildArgs = @(
            "ColorCop.sln"
            "/p:Configuration=${{ matrix.configuration }}"
            "/p:Platform=Win32"
            "/p:RunCodeAnalysis=true"
            "/p:CodeAnalysisRuleSet=NativeMinimumRules.ruleset"
            "/p:CodeAnalysisTreatWarningsAsErrors=false"
          )
          MSBuild.exe $msbuildArgs

      # Clean and prepare distribution directory
      - name: Prepare Distribution Directory
        run: |
          rmdir /S /Q Release-standalone
          mkdir Release-standalone

      # Copy files to distribution directory
      - name: Copy Files
        run: |
          copy Release\*.exe Release-standalone
          copy ReadMe.txt Release-standalone
          copy LICENSE.TXT Release-standalone
          copy packaging\*.HLP Release-standalone

      - name: Publish Release Artifacts
        uses: actions/upload-artifact@v4
        if: matrix.configuration == 'Release'
        with:
          name: windows_artifacts_release
          path: |
            ${{ github.workspace }}/Release/*.exe
          retention-days: 30
