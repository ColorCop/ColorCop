name: build

on:
  push:
  pull_request:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        configuration: [Debug, Release]

    runs-on: windows-2022

    # Grant minimal read-only access to repository contents
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Print First 10 Characters
        run: |
          echo "AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:0:10}"
          echo "AWS_DEFAULT_REGION: ${AWS_DEFAULT_REGION:0:10}"
          echo "AWS_S3_BUCKET_NAME: ${AWS_S3_BUCKET_NAME:0:10}"
          echo "AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:0:10}"
          echo "SELLER_ID: ${SELLER_ID:0:10}"
          echo "TENANT_ID: ${TENANT_ID:0:10}"

      - name: Add MSBuild to PATH
        uses: microsoft/setup-msbuild@v2

      - name: Install MFC libraries via Chocolatey
        run: |
          Write-Host "Installing MFC components via Chocolatey..."
          choco install visualstudio2022-workload-vctools --package-parameters "--add Microsoft.VisualStudio.Component.VC.ATLMFC" --yes

          # Wait for installation to complete
          Start-Sleep -Seconds 30

          # Verify installation
          $mfcPath = Get-ChildItem "${env:ProgramFiles}\Microsoft Visual Studio\2022\Enterprise\VC\Tools\MSVC\*\atlmfc" -ErrorAction SilentlyContinue
          if ($mfcPath) {
            Write-Host "✅ MFC libraries found at: $($mfcPath.FullName)"
          } else {
            Write-Host "❌ MFC installation failed"
            Get-ChildItem "${env:ProgramFiles}\Microsoft Visual Studio\2022\Enterprise\VC\Tools\MSVC\" -ErrorAction SilentlyContinue
            exit 1
          }
        shell: powershell

      - name: Run MSBuild with Code Analysis
        run: |
          $msbuildArgs = @(
            "ColorCop.sln"
            "/p:Configuration=${{ matrix.configuration }}"
            "/p:Platform=Win32"
            "/p:RunCodeAnalysis=true"
            "/p:CodeAnalysisRuleSet=NativeMinimumRules.ruleset"
            "/p:CodeAnalysisTreatWarningsAsErrors=false"
          )
          MSBuild.exe $msbuildArgs

      - name: Build x64 Installer
        uses: Minionguyjpro/Inno-Setup-Action@v1.2.7
        if: matrix.configuration == 'Release'
        with:
          path: inno\colorcop.iss
          options: /O+

      - name: Publish Release Artifacts
        uses: actions/upload-artifact@v5
        if: matrix.configuration == 'Release'
        with:
          name: installers
          path: .\output
          retention-days: 30
