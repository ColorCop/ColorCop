name: Build and Publish Chocolatey Package

on:
  release:
    types: [published]

  # Allow manual runs for testing
  workflow_dispatch:
    inputs:
      version:
        description: Version to package (e.g., 1.0.0)
        required: false
        default: 0.0.0-test

jobs:
  build-choco:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine version
        id: get_version
        run: |
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $version = "${{ github.event.inputs.version }}"
          } else {
            $tag = "${{ github.event.release.tag_name }}"
            $version = $tag.TrimStart("v")
          }
          echo "version=$version" >> $env:GITHUB_OUTPUT

      - name: Download release asset (only for real releases)
        if: ${{ github.event_name == 'release' }}
        run: |
          gh release download ${{ github.event.release.tag_name }} `
            --repo ${{ github.repository }} `
            --pattern "colorcop-setup.exe"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Use local test EXE if manual run
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          echo "Creating dummy test EXE"
          echo "Test build for version ${{ steps.get_version.outputs.version }}" > colorcop-setup.exe

      - name: Install Chocolatey
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force
          [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.SecurityProtocolType]::Tls12
          iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))

      - name: Prepare tools folder
        run: |
          mkdir choco/tools -Force
          Copy-Item colorcop-setup.exe choco/tools/
          Copy-Item LICENSE.TXT choco/tools/

      - name: Generate checksum
        shell: pwsh
        run: |
          $sha = (Get-FileHash choco/tools/colorcop-setup.exe -Algorithm SHA256).Hash
          echo "ASSET_SHA256=$sha" >> $env:GITHUB_ENV

      - name: Update nuspec version
        run: |
          $version = "${{ steps.get_version.outputs.version }}"
          (Get-Content choco/colorcop.nuspec) `
            -replace '<version>[^<]+</version>', "<version>$version</version>" `
            | Set-Content choco/colorcop.nuspec

      - name: Generate VERIFICATION.txt from template
        run: |
          $url = "https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/colorcop-setup.exe"
          $checksum = "${{ steps.checksum.outputs.sha256 }}"

          (Get-Content tools/VERIFICATION.template.txt) `
            -replace "{{URL}}", $url `
            -replace "{{CHECKSUM}}", $checksum `
            | Set-Content tools/VERIFICATION.txt

      - name: Dump generated files
        shell: pwsh
        run: |
          Write-Host "=== VERIFICATION.txt ==="
          Get-Content choco\tools\VERIFICATION.txt
          Write-Host "`n=== chocolateyinstall.ps1 ==="
          Get-Content choco\tools\chocolateyinstall.ps1
          Write-Host "`n=== colorcop.nuspec ==="
          Get-Content choco\colorcop.nuspec

      - name: Build Chocolatey package
        working-directory: choco
        run: choco pack --debug

      - name: Upload .nupkg artifact
        uses: actions/upload-artifact@v4
        with:
          name: chocolatey-package
          path: "choco/*.nupkg"

      - name: Push to Chocolatey.org
      # only push if this is a real release, not a manual test run
        if: ${{ github.event_name == 'release' }}
        run: |
          choco push choco/*.nupkg `
            --source https://push.chocolatey.org/ `
            --api-key ${{ secrets.CHOCO_API_KEY }} `
            --yes
