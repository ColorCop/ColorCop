name: build

on:
  push:
    tags:
      - 'v*'
  pull_request:
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        configuration: [Release]

    runs-on: windows-2022

    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Add MSBuild to PATH
        uses: microsoft/setup-msbuild@v2

      - name: Install MFC libraries via Chocolatey
        run: |
          Write-Host "Installing MFC components via Chocolatey..."
          choco install visualstudio2022-workload-vctools --package-parameters "--add Microsoft.VisualStudio.Component.VC.ATLMFC" --yes

          # Wait for installation to complete
          Start-Sleep -Seconds 30

          # Verify installation
          $mfcPath = Get-ChildItem "${env:ProgramFiles}\Microsoft Visual Studio\2022\Enterprise\VC\Tools\MSVC\*\atlmfc" -ErrorAction SilentlyContinue
          if ($mfcPath) {
            Write-Host "✅ MFC libraries found at: $($mfcPath.FullName)"
          } else {
            Write-Host "❌ MFC installation failed"
            Get-ChildItem "${env:ProgramFiles}\Microsoft Visual Studio\2022\Enterprise\VC\Tools\MSVC\" -ErrorAction SilentlyContinue
            exit 1
          }
        shell: powershell

      - name: Run MSBuild with Code Analysis
        run: |
          $msbuildArgs = @(
            "ColorCop.sln"
            "/p:Configuration=${{ matrix.configuration }}"
            "/p:Platform=Win32"
            "/p:RunCodeAnalysis=true"
            "/p:CodeAnalysisRuleSet=NativeMinimumRules.ruleset"
            "/p:CodeAnalysisTreatWarningsAsErrors=false"
          )
          MSBuild.exe $msbuildArgs

      - name: Build x64 Installer
        uses: Minionguyjpro/Inno-Setup-Action@v1.2.7
        if: matrix.configuration == 'Release'
        with:
          path: inno\colorcop.iss
          options: /O+

      - name: Publish Release Artifacts
        uses: actions/upload-artifact@v6
        if: matrix.configuration == 'Release'
        with:
          name: installers
          path: .\output
          retention-days: 30

      - name: Create Flat Zip Archive
        run: |
          Remove-Item -Path "Release-standalone" -Recurse -Force -ErrorAction SilentlyContinue

          New-Item -ItemType Directory -Path "Release-standalone"

          Copy-Item -Path "Release\*.exe" -Destination "Release-standalone"
          Copy-Item -Path "ReadMe.txt" -Destination "Release-standalone"
          Copy-Item -Path "LICENSE.txt" -Destination "Release-standalone"
          Copy-Item -Path "packaging\*.chm" -Destination "Release-standalone"

          Set-Location "Release-standalone"

          Compress-Archive -Path "*" -DestinationPath "../colorcop.zip" -Force
        shell: pwsh

      - name: Publish Release Artifacts
        uses: actions/upload-artifact@v6
        if: matrix.configuration == 'Release'
        with:
          name: colorcop-zip
          path: colorcop.zip
          retention-days: 30

      - name: Release to GitHub Releases
        uses: softprops/action-gh-release@v2
        if: github.ref_type == 'tag'
        with:
          files: |
            colorcop.zip
            output/colorcop-setup.exe


